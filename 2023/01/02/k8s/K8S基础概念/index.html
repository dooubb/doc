<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/qpp.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/qpp.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"dooubb.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="Kubernetes 组件  Master节点 Master节点是集群的控制节点，由API Server、Scheduler、Controller Manager和ETCD四个组件构成。  API Server：各组件互相通讯的中转站，接受外部请求，并将信息写到ETCD中。 Controller Manager：执行集群级功能，例如复制组件，跟踪Node节点，处理节点故障等等。 Scheduler">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s基础概念">
<meta property="og:url" content="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/index.html">
<meta property="og:site_name" content="doubao">
<meta property="og:description" content="Kubernetes 组件  Master节点 Master节点是集群的控制节点，由API Server、Scheduler、Controller Manager和ETCD四个组件构成。  API Server：各组件互相通讯的中转站，接受外部请求，并将信息写到ETCD中。 Controller Manager：执行集群级功能，例如复制组件，跟踪Node节点，处理节点故障等等。 Scheduler">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220815222135791.png">
<meta property="og:image" content="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220815222237485.png">
<meta property="og:image" content="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220815225858369.png">
<meta property="og:image" content="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220815225949945.png">
<meta property="og:image" content="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220816210111583.png">
<meta property="og:image" content="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220816215943427.png">
<meta property="og:image" content="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220817222302611.png">
<meta property="og:image" content="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220818185709648.png">
<meta property="og:image" content="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220818200748512.png">
<meta property="article:published_time" content="2023-01-02T05:52:42.133Z">
<meta property="article:modified_time" content="2022-08-20T06:21:36.374Z">
<meta property="article:author" content="doubao">
<meta property="article:tag" content="K8S">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220815222135791.png">

<link rel="canonical" href="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>k8s基础概念 | doubao</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">doubao</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://dooubb.github.io/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="doubao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="doubao">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s基础概念
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-02 13:52:42" itemprop="dateCreated datePublished" datetime="2023-01-02T13:52:42+08:00">2023-01-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-20 14:21:36" itemprop="dateModified" datetime="2022-08-20T14:21:36+08:00">2022-08-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/K8S/" itemprop="url" rel="index"><span itemprop="name">K8S</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>39k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>36 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Kubernetes-组件"><a href="#Kubernetes-组件" class="headerlink" title="Kubernetes 组件"></a>Kubernetes 组件</h1><img src="/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220815222135791.png" class title="image-20220815222135791">

<p><strong>Master节点</strong></p>
<p>Master节点是集群的控制节点，由API Server、Scheduler、Controller Manager和ETCD四个组件构成。</p>
<ul>
<li>API Server：各组件互相通讯的中转站，接受外部请求，并将信息写到ETCD中。</li>
<li>Controller Manager：执行集群级功能，例如复制组件，跟踪Node节点，处理节点故障等等。</li>
<li>Scheduler：负责应用调度的组件，根据各种条件（如可用的资源、节点的亲和性等）将容器调度到Node上运行。</li>
<li>ETCD：一个分布式数据存储组件，负责存储集群的配置信息。</li>
</ul>
<p>在生产环境中，为了保障集群的高可用，通常会部署多个master，如CCE的集群高可用模式就是3个master节点。</p>
<p><strong>Node节点</strong></p>
<p>Node节点是集群的计算节点，即运行容器化应用的节点。</p>
<ul>
<li>kubelet：kubelet主要负责同Container Runtime打交道，并与API Server交互，管理节点上的容器。</li>
<li>kube-proxy：应用组件间的访问代理，解决节点上应用的访问问题。</li>
<li>Container Runtime：容器运行时，如Docker，最主要的功能是下载镜像和运行容器。</li>
</ul>
<span id="more"></span>

<h1 id="Kubernetes的扩展性"><a href="#Kubernetes的扩展性" class="headerlink" title="Kubernetes的扩展性"></a>Kubernetes的扩展性</h1><p>Kubernetes开放了容器运行时接口（CRI）、容器网络接口（CNI）和容器存储接口（CSI），这些接口让Kubernetes的扩展性变得最大化，而Kubernetes本身则专注于容器调度。</p>
<ul>
<li>CRI（Container Runtime Interface）：容器运行时接口，提供计算资源，CRI隔离了各个容器引擎之间的差异，而通过统一的接口与各个容器引擎之间进行互动。</li>
<li>CNI（Container Network Interface）：容器网络接口，提供网络资源，通过CNI接口，Kubernetes可以支持不同网络环境。</li>
<li>CSI（Container Storage Interface）：容器存储接口，提供存储资源，通过CSI接口，Kubernetes可以支持各种类型的存储。</li>
</ul>
<h1 id="Kubernetes中的基本对象"><a href="#Kubernetes中的基本对象" class="headerlink" title="Kubernetes中的基本对象"></a>Kubernetes中的基本对象</h1><img src="/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220815222237485.png" class title="image-20220815222237485">

<ul>
<li><p>Pod</p>
<p>Pod是Kubernetes创建或部署的最小单位。一个Pod封装一个或多个容器（container）、存储资源（volume）、一个独立的网络IP以及管理控制容器运行方式的策略选项。</p>
</li>
<li><p>Deployment</p>
<p>Deployment是对Pod的服务化封装。一个Deployment可以包含一个或多个Pod，每个Pod的角色相同，所以系统会自动为Deployment的多个Pod分发请求。</p>
</li>
<li><p>StatefulSet</p>
<p>StatefulSet是用来管理有状态应用的对象。和Deployment相同的是，StatefulSet管理了基于相同容器定义的一组Pod。但和Deployment不同的是，StatefulSet为它们的每个Pod维护了一个固定的ID。这些Pod是基于相同的声明来创建的，但是不能相互替换，无论怎么调度，每个Pod都有一个永久不变的ID。</p>
</li>
<li><p>Job</p>
<p>Job是用来控制批处理型任务的对象。批处理业务与长期伺服业务（Deployment）的主要区别是批处理业务的运行有头有尾，而长期伺服业务在用户不停止的情况下永远运行。Job管理的Pod根据用户的设置把任务成功完成就自动退出（Pod自动删除）。</p>
</li>
<li><p>CronJob</p>
<p>CronJob是基于时间控制的Job，类似于Linux系统的crontab，在指定的时间周期运行指定的任务。</p>
</li>
<li><p>DaemonSet</p>
<p>DaemonSet是这样一种对象（守护进程），它在集群的每个节点上运行一个Pod，且保证只有一个Pod，这非常适合一些系统层面的应用，例如日志收集、资源监控等，这类应用需要每个节点都运行，且不需要太多实例，一个比较好的例子就是Kubernetes的kube-proxy。</p>
</li>
<li><p>Service</p>
<p>Service是用来解决Pod访问问题的。Service有一个固定IP地址，Service将访问流量转发给Pod，而且Service可以给这些Pod做负载均衡。</p>
</li>
<li><p>Ingress</p>
<p>Service是基于四层TCP和UDP协议转发的，Ingress可以基于七层的HTTP和HTTPS协议转发，可以通过域名和路径做到更细粒度的划分。</p>
</li>
<li><p>ConfigMap</p>
<p>ConfigMap是一种用于存储应用所需配置信息的资源类型，用于保存配置数据的键值对。通过ConfigMap可以方便的做到配置解耦，使得不同环境有不同的配置。</p>
</li>
<li><p>Secret</p>
<p>Secret是一种加密存储的资源对象，您可以将认证信息、证书、私钥等保存在Secret中，而不需要把这些敏感数据暴露到镜像或者Pod定义中，从而更加安全和灵活。</p>
</li>
<li><p>PersistentVolume（PV）</p>
<p>PV指持久化数据存储卷，主要定义的是一个持久化存储在宿主机上的目录，比如一个NFS的挂载目录。</p>
</li>
<li><p>PersistentVolumeClaim（PVC）</p>
<p>Kubernetes提供PVC专门用于持久化存储的申请，PVC可以让您无需关心底层存储资源如何创建、释放等动作，而只需要申明您需要何种类型的存储资源、多大的存储空间。</p>
</li>
</ul>
<h1 id="Kubernetes对象的描述"><a href="#Kubernetes对象的描述" class="headerlink" title="Kubernetes对象的描述"></a>Kubernetes对象的描述</h1><p>kubernetes中资源可以使用YAML描述，也可以使用JSON。其内容可以分为如下四个部分：</p>
<ul>
<li>typeMeta：对象类型的元信息，声明对象使用哪个API版本，哪个类型的对象。</li>
<li>objectMeta：对象的元信息，包括对象名称、使用的标签等。</li>
<li>spec：对象的期望状态，例如对象使用什么镜像、有多少副本等。</li>
<li>status：对象的实际状态，只能在对象创建后看到，创建对象时无需指定。</li>
</ul>
<h1 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h1><h2 id="Pod基础信息"><a href="#Pod基础信息" class="headerlink" title="Pod基础信息"></a>Pod基础信息</h2><p><strong><code>Kubernetes中的最小调度对象</code></strong></p>
<p>Pod是Kubernetes创建或部署的最小单位。一个Pod封装一个或多个容器（container）、存储资源（volume）、一个独立的网络IP以及管理控制容器运行方式的策略选项。</p>
<p>Pod使用主要分为两种方式：</p>
<ul>
<li>Pod中运行一个容器。这是Kubernetes最常见的用法，您可以将Pod视为单个封装的容器，但是Kubernetes是直接管理Pod而不是容器。</li>
<li>Pod中运行多个需要耦合在一起工作、需要共享资源的容器。通常这种场景下应用包含一个主容器和几个辅助容器（SideCar Container）。</li>
</ul>
<p>创建pod的yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>                      <span class="comment"># Kubernetes的API Version</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>                           <span class="comment"># Kubernetes的资源类型</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span>                       <span class="comment"># Pod的名称</span></span><br><span class="line"><span class="attr">spec:</span>                               <span class="comment"># Pod的具体规格（specification）</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span>             <span class="comment"># 使用的镜像为 nginx:alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">container-0</span>               <span class="comment"># 容器的名称</span></span><br><span class="line">    <span class="attr">resources:</span>                      <span class="comment"># 申请容器所需的资源</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">    <span class="attr">env:</span>                            <span class="comment"># 环境变量</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">env_key</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">env_value</span>  </span><br><span class="line">    <span class="attr">command:</span>                     <span class="comment"># 启动命令</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">top</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;-b&quot;</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span>                 <span class="comment"># 启动后处理</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;/postStart.sh&quot;</span></span><br><span class="line">      <span class="attr">preStop:</span>                   <span class="comment"># 停止前处理</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;/preStop.sh&quot;</span>  </span><br><span class="line">  <span class="attr">imagePullSecrets:</span>                 <span class="comment"># 拉取镜像使用的证书</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br></pre></td></tr></table></figure>

<h2 id="Pod-存活探针（Liveness-Probe）"><a href="#Pod-存活探针（Liveness-Probe）" class="headerlink" title="Pod 存活探针（Liveness Probe）"></a>Pod 存活探针（Liveness Probe）</h2><p>Kubernetes支持如下三种探测机制。</p>
<ul>
<li>HTTP GET：向容器发送HTTP GET请求，如果Probe收到2xx或3xx，说明容器是健康的。</li>
<li>TCP Socket：尝试与容器指定端口建立TCP连接，如果连接成功建立，说明容器是健康的。</li>
<li>Exec：Probe执行容器中的命令并检查命令退出的状态码，如果状态码为0则说明容器是健康的。</li>
</ul>
<h3 id="HTTP-GET"><a href="#HTTP-GET" class="headerlink" title="HTTP GET"></a>HTTP GET</h3><p>HTTP GET方式是最常见的探测方法，其具体机制是向容器发送HTTP GET请求，如果Probe收到2xx或3xx，说明容器是健康的</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-http</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">livenessProbe:</span>				 <span class="comment"># liveness probe</span></span><br><span class="line">      <span class="attr">httpGet:</span>					 <span class="comment"># HTTP GET定义</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span>    <span class="comment"># 容器启动后多久开始探测</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">2</span>          <span class="comment"># 表示容器必须在2s内做出相应反馈给probe，否则视为探测失败</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">30</span>          <span class="comment"># 探测周期，每30s探测一次</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span>        <span class="comment"># 连续探测1次成功表示成功</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span>        <span class="comment"># 连续探测3次失败表示失败</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br></pre></td></tr></table></figure>

<h3 id="TCP-Socket"><a href="#TCP-Socket" class="headerlink" title="TCP Socket"></a>TCP Socket</h3><p>TCP Socket尝试与容器指定端口建立TCP连接，如果连接成功建立，说明容器是健康的</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-tcp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">livenessProbe:</span>           <span class="comment"># liveness probe</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br></pre></td></tr></table></figure>

<h3 id="Exec"><a href="#Exec" class="headerlink" title="Exec"></a>Exec</h3><p>Exec即执行具体命令，具体机制是Probe执行容器中的命令并检查命令退出的状态码，如果状态码为0则说明健康</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-exec</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30</span><span class="string">;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">600</span></span><br><span class="line">    <span class="attr">livenessProbe:</span>           <span class="comment"># liveness probe</span></span><br><span class="line">      <span class="attr">exec:</span>                  <span class="comment"># Exec定义</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br></pre></td></tr></table></figure>

<h2 id="Pod就绪探针（Readiness-Probe）"><a href="#Pod就绪探针（Readiness-Probe）" class="headerlink" title="Pod就绪探针（Readiness Probe）"></a>Pod就绪探针（Readiness Probe）</h2><p>Kubernetes支持如下三种类型。</p>
<ul>
<li>Exec：Probe执行容器中的命令并检查命令退出的状态码，如果状态码为0则说明已经就绪。</li>
<li>HTTP GET：往容器的IP:Port发送HTTP GET请求，如果Probe收到2xx或3xx，说明已经就绪。</li>
<li>TCP Socket：尝试与容器建立TCP连接，如果能建立连接说明已经就绪。</li>
</ul>
<h3 id="HTTP-GET-1"><a href="#HTTP-GET-1" class="headerlink" title="HTTP GET"></a>HTTP GET</h3><p>Readiness Probe的配置与<code>存活探针（livness probe）</code>一样，都是在Pod Template的containers里面，如下所示，这个Readiness Probe向Pod发送HTTP请求，当Probe收到2xx或3xx返回时，说明Pod已经就绪</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">container-0</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">readinessProbe:</span>           <span class="comment"># readinessProbe</span></span><br><span class="line">          <span class="attr">httpGet:</span>                <span class="comment"># HTTP GET定义</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/read</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span>    <span class="comment"># 容器启动后多久开始探测</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">2</span>          <span class="comment"># 表示容器必须在2s内做出相应反馈给probe，否则视为探测失败</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">30</span>          <span class="comment"># 探测周期，每30s探测一次</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span>        <span class="comment"># 连续探测1次成功表示成功</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span>        <span class="comment"># 连续探测3次失败表示失败</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br></pre></td></tr></table></figure>

<h3 id="TCP-Socket-1"><a href="#TCP-Socket-1" class="headerlink" title="TCP Socket"></a>TCP Socket</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">container-0</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">readinessProbe:</span>             <span class="comment"># readinessProbe</span></span><br><span class="line">          <span class="attr">tcpSocket:</span>                <span class="comment"># TCP Socket定义</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br></pre></td></tr></table></figure>

<h3 id="Exec-1"><a href="#Exec-1" class="headerlink" title="Exec"></a>Exec</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">container-0</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">readinessProbe:</span>      <span class="comment"># Readiness Probe</span></span><br><span class="line">          <span class="attr">exec:</span>              <span class="comment"># 定义 ls /ready 命令</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ls</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/ready</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br></pre></td></tr></table></figure>

<h2 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h2><p><strong><code>组织Pod的利器: Kubernetes提供了一种机制来为资源分类，那就是Label（标签）</code></strong></p>
<p>没有分类组织的Pod</p>
<img src="/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220815225858369.png" class title="image-20220815225858369">

<p>使用Label组织的Pod</p>
<img src="/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220815225949945.png" class title="image-20220815225949945">

<h3 id="添加Label"><a href="#添加Label" class="headerlink" title="添加Label"></a>添加Label</h3><p>Label的形式为key-value形式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment"># 为Pod设置两个Label    </span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span>    </span><br><span class="line">    <span class="attr">env:</span> <span class="string">prod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">container-0</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br></pre></td></tr></table></figure>

<h3 id="查看Label"><a href="#查看Label" class="headerlink" title="查看Label"></a>查看Label</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod --show-labels</span><br></pre></td></tr></table></figure>

<h3 id="修改Label"><a href="#修改Label" class="headerlink" title="修改Label"></a>修改Label</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nginx是上面的pod的name</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">label</span> <span class="string">pod</span> <span class="string">nginx</span> <span class="string">env=debug</span> <span class="string">--overwrite</span></span><br></pre></td></tr></table></figure>

<h1 id="Pod的编排与调度"><a href="#Pod的编排与调度" class="headerlink" title="Pod的编排与调度"></a>Pod的编排与调度</h1><h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>一个Deployment可以包含一个或多个Pod副本，每个Pod副本的角色相同，并且提供副本管理、滚动升级和自愈能力</p>
<h3 id="Deployment的创建"><a href="#Deployment的创建" class="headerlink" title="Deployment的创建"></a>Deployment的创建</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> 			<span class="comment"># 注意这里与Pod的区别，Deployment是apps/v1而不是v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span> 				<span class="comment"># 资源类型为Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-web</span> 				<span class="comment"># Deployment的名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mall-dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span> 					<span class="comment"># Pod的数量，Deployment会确保一直有2个Pod运行</span></span><br><span class="line">  <span class="attr">selector:</span>						<span class="comment"># Label Selector</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis-web</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span>						<span class="comment"># Pod的定义，用于创建Pod，也称为Pod template</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis-web</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ALLOW_EMPTY_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;yes&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REDIS_REPLICATION_MOD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">master</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis:5</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis-web</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">            <span class="attr">ephemeral-storage:</span> <span class="string">1Gi</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">            <span class="attr">ephemeral-storage:</span> <span class="string">200Mi</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">private-registry-secret</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">2000</span></span><br><span class="line">        <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<p>使用kubectl get查看Deployment和Pod，可以看到<strong>READY</strong>值为2&#x2F;2，前一个2表示当前有2个Pod运行，后一个2表示期望有2个Pod，<strong>AVAILABLE</strong>为2表示有2个Pod是可用的。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get deployments.apps -n mall-dev</span></span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">redis-web      2/2     2            2           146d</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Deployment控制Pod"><a href="#Deployment控制Pod" class="headerlink" title="Deployment控制Pod"></a>Deployment控制Pod</h3><p>Deployment是通过一种名为ReplicaSet的控制器控制Pod。</p>
<p><code>Deployment控制ReplicaSet，ReplicaSet控制Pod</code></p>
<p>查询ReplicaSet命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl get rs -n mall-dev</span></span><br><span class="line">NAME                      DESIRED   CURRENT   READY   AGE</span><br><span class="line">redis-web-db6f7cd87       2         2         2       145d</span><br></pre></td></tr></table></figure>

<p>使用kubectl describe命令查看Deployment的详情，您就可以看到ReplicaSet</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master ~]<span class="comment"># kubectl describe deployments.apps redis-web -n mall-dev</span></span><br><span class="line">Name:                   redis-web</span><br><span class="line">Namespace:              mall-dev</span><br><span class="line">CreationTimestamp:      Tue, 22 Mar 2022 01:10:22 +0800</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 6</span><br><span class="line">Selector:               app=redis-web</span><br><span class="line">Replicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:       app=redis-web</span><br><span class="line">  Annotations:  kubectl.kubernetes.io/restartedAt: 2022-03-23T22:51:20+08:00</span><br><span class="line">  Containers:</span><br><span class="line">   redis-web:</span><br><span class="line">    Image:      redis:5</span><br><span class="line">    Port:       6379/TCP</span><br><span class="line">    Host Port:  0/TCP</span><br><span class="line">    Limits:</span><br><span class="line">      cpu:                2</span><br><span class="line">      ephemeral-storage:  1Gi</span><br><span class="line">      memory:             256Mi</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:                200m</span><br><span class="line">      ephemeral-storage:  200Mi</span><br><span class="line">      memory:             128Mi</span><br><span class="line">    Environment:</span><br><span class="line">      ALLOW_EMPTY_PASSWORD:   <span class="built_in">yes</span></span><br><span class="line">      REDIS_REPLICATION_MOD:  master</span><br><span class="line">    Mounts:                   &lt;none&gt;</span><br><span class="line">  Volumes:                    &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   redis-web-db6f7cd87 (2/2 replicas created) <span class="comment">#ReplicaSet信息</span></span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age    From                   Message</span><br><span class="line">  ----    ------             ----   ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  9m14s  deployment-controller  Scaled up replica <span class="built_in">set</span> redis-web-db6f7cd87 to 2</span><br></pre></td></tr></table></figure>

<h3 id="Deployment升级"><a href="#Deployment升级" class="headerlink" title="Deployment升级"></a>Deployment升级</h3><p>Deployment可以设置不同的升级策略，有如下两种。</p>
<ul>
<li>RollingUpdate：滚动升级，即逐步创建新Pod再删除旧Pod，为默认策略。</li>
<li>Recreate：替换升级，即先把当前Pod删掉再重新创建Pod。</li>
</ul>
<p>Deployment可以通过maxSurge和maxUnavailable两个参数控制升级过程中同时重新创建Pod的比例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br></pre></td></tr></table></figure>

<ul>
<li>maxSurge：与Deployment中spec.replicas相比，可以有多少个Pod存在，默认值是25%，比如spec.replicas为 4，那升级过程中就不能超过5个Pod存在，即按1个的步伐升级，实际升级过程中会换算成数字，且换算会向上取整。这个值也可以直接设置成数字。</li>
<li>maxUnavailable：与Deployment中spec.replicas相比，可以有多少个Pod失效，也就是删除的比例，默认值是25%，比如spec.replicas为4，那升级过程中就至少有3个Pod存在，即删除Pod的步伐是1。同样这个值也可以设置成数字。</li>
</ul>
<h3 id="Deployment回滚"><a href="#Deployment回滚" class="headerlink" title="Deployment回滚"></a>Deployment回滚</h3><p>回滚也称为回退，即当发现升级出现问题时，让应用回到老的版本。Deployment可以非常方便的回滚到老版本。</p>
<p>假如上面升级的新版镜像有问题，可以执行kubectl rollout undo命令进行回滚。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment redis-web</span><br></pre></td></tr></table></figure>

<h2 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h2><p>Deployment控制器下的Pod都有个共同特点，那就是每个Pod除了名称和IP地址不同，其余完全相同。需要的时候，Deployment可以通过Pod模板创建新的Pod；不需要的时候，Deployment就可以删除任意一个Pod。</p>
<p>详细分析下有状态应用的需求，分布式有状态的特点主要是应用中每个部分的角色不同（即分工不同），比如数据库有主备，Pod之间有依赖，对应到Kubernetes中就是对Pod有如下要求：</p>
<ul>
<li>Pod能够被别的Pod找到，这就要求Pod有固定的标识。</li>
<li>每个Pod有单独存储，Pod被删除恢复后，读取的数据必须还是以前那份，否则状态就会不一致。</li>
</ul>
<p>Kubernetes提供了StatefulSet来解决这个问题，其具体如下：</p>
<ol>
<li>StatefulSet给每个Pod提供固定名称，Pod名称增加从0-N的固定后缀，Pod重新调度后Pod名称和HostName不变。</li>
<li>StatefulSet通过Headless Service给每个Pod提供固定的访问域名，Service的概念会在后面章节中详细介绍。</li>
<li>StatefulSet通过创建固定标识的PVC保证Pod重新调度后还是能访问到相同的持久化数据。</li>
</ol>
<img src="/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220816210111583.png" class title="image-20220816210111583">





<h3 id="创建Headless-Service"><a href="#创建Headless-Service" class="headerlink" title="创建Headless Service"></a>创建Headless Service</h3><p>创建Statefulset需要一个Headless Service用于Pod访问</p>
<p>使用如下文件描述Headless Service，其中：</p>
<ul>
<li>spec.clusterIP：必须设置为None，表示Headless Service。</li>
<li>spec.ports.port：Pod间通信端口号。</li>
<li>spec.ports.name：Pod间通信端口名称。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>       <span class="comment"># 对象类型为Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span>     <span class="comment"># Pod间通信的端口名称</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span>        <span class="comment"># Pod间通信的端口号</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span>        <span class="comment"># 选择标签为app:nginx的Pod</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span>     <span class="comment"># 必须设置为None，表示Headless Service</span></span><br></pre></td></tr></table></figure>

<p><strong><code>创建后的service</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get service  -n mall-dev</span></span><br><span class="line">NAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">nginx   ClusterIP   None            &lt;none&gt;        80/TCP     2m26s</span><br><span class="line">redis   ClusterIP   10.96.121.105   &lt;none&gt;        6379/TCP   147d</span><br></pre></td></tr></table></figure>

<h3 id="创建Statefulset"><a href="#创建Statefulset" class="headerlink" title="创建Statefulset"></a>创建Statefulset</h3><p><strong><code>serviceName指定了Statefulset使用哪个Headless Service</code></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">nginx</span>                             <span class="comment"># headless service的名称</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">container-0</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br></pre></td></tr></table></figure>

<p><strong><code>创建后的pod</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl get pod -n mall-dev</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-0                     1/1     Running   0          5m43s</span><br><span class="line">nginx-1                     1/1     Running   0          3m59s</span><br><span class="line">nginx-2                     1/1     Running   0          3m55s</span><br><span class="line">redis-web-db6f7cd87-2pzff   1/1     Running   1          22h</span><br><span class="line">redis-web-db6f7cd87-s4nph   1/1     Running   4          59d</span><br></pre></td></tr></table></figure>

<p><strong><code>删除pod后再查看pod</code></strong></p>
<p>会发现k8s会重新创建一个name一样的pod出来</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get pod -n mall-dev</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-0                     1/1     Running   0          11m</span><br><span class="line">nginx-1                     1/1     Running   0          9m24s</span><br><span class="line">nginx-2                     1/1     Running   0          9m20s</span><br><span class="line">redis-web-db6f7cd87-2pzff   1/1     Running   1          22h</span><br><span class="line">redis-web-db6f7cd87-s4nph   1/1     Running   4          59d</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl delete pod nginx-0 -n mall-dev</span></span><br><span class="line">pod <span class="string">&quot;nginx-0&quot;</span> deleted</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get pod -n mall-dev</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-0                     1/1     Running   0          2s</span><br><span class="line">nginx-1                     1/1     Running   0          9m50s</span><br><span class="line">nginx-2                     1/1     Running   0          9m46s</span><br><span class="line">redis-web-db6f7cd87-2pzff   1/1     Running   1          22h</span><br><span class="line">redis-web-db6f7cd87-s4nph   1/1     Running   4          59d</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get pod -n mall-dev</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-0                     1/1     Running   0          4s</span><br><span class="line">nginx-1                     1/1     Running   0          9m52s</span><br><span class="line">nginx-2                     1/1     Running   0          9m48s</span><br><span class="line">redis-web-db6f7cd87-2pzff   1/1     Running   1          22h</span><br><span class="line">redis-web-db6f7cd87-s4nph   1/1     Running   4          59d</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p><strong><code>进入pod内部查看hostname</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl exec nginx-0 -n mall-dev -- sh -c &#x27;hostname&#x27; </span></span><br><span class="line">nginx-0</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl exec nginx-1 -n mall-dev -- sh -c &#x27;hostname&#x27; </span></span><br><span class="line">nginx-1</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl exec nginx-2 -n mall-dev -- sh -c &#x27;hostname&#x27; </span></span><br><span class="line">nginx-2</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h3 id="StatefulSet的网络标识"><a href="#StatefulSet的网络标识" class="headerlink" title="StatefulSet的网络标识"></a>StatefulSet的网络标识</h3><p>StatefulSet创建后，可以看下Pod是有固定名称的，那Headless Service是如何起作用的呢，那就是使用DNS，为Pod提供固定的域名，这样Pod间就可以使用域名访问，即便Pod被重新创建而导致Pod的IP地址发生变化，这个域名也不会发生变化。</p>
<p>Headless Service创建后，每个Pod的IP都会有下面格式的域名。</p>
<p><strong><code>&lt;pod-name&gt;.&lt;svc-name&gt;.&lt;namespace&gt;.svc.cluster.local</code></strong></p>
<p>例如上面的三个Pod的域名就是：</p>
<ul>
<li>nginx-0.nginx.mall-dev.svc.cluster.local</li>
<li>nginx-1.nginx.mall-dev..svc.cluster.local</li>
<li>nginx-2.nginx.mall-dev.ult.svc.cluster.local</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl run -it --image=busybox:1.28.3 --restart=Never -n mall-dev dns-test /bin/sh</span></span><br><span class="line">/ <span class="comment">#  nslookup nginx-0.nginx</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx-0.nginx</span><br><span class="line">Address 1: 192.167.58.202 nginx-0.nginx.mall-dev.svc.cluster.local</span><br><span class="line">/ <span class="comment">#  nslookup nginx-1.nginx</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx-1.nginx</span><br><span class="line">Address 1: 192.167.85.204 nginx-1.nginx.mall-dev.svc.cluster.local</span><br><span class="line">/ <span class="comment">#  nslookup nginx-2.nginx</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx-2.nginx</span><br><span class="line">Address 1: 192.167.85.203 nginx-2.nginx.mall-dev.svc.cluster.local</span><br><span class="line">/ <span class="comment"># </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><code>删除一个pod后在查看dns</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除pod</span></span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get pod -n mall-dev </span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">dns-test                    1/1     Running   0          75s</span><br><span class="line">nginx-0                     1/1     Running   0          31m</span><br><span class="line">nginx-1                     1/1     Running   0          41m</span><br><span class="line">nginx-2                     1/1     Running   0          41m</span><br><span class="line">redis-web-db6f7cd87-2pzff   1/1     Running   1          22h</span><br><span class="line">redis-web-db6f7cd87-s4nph   1/1     Running   4          59d</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl delete pod -n mall-dev nginx-0</span></span><br><span class="line">pod <span class="string">&quot;nginx-0&quot;</span> deleted</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get pod -n mall-dev </span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">dns-test                    1/1     Running   0          2m47s</span><br><span class="line">nginx-0                     1/1     Running   0          71s</span><br><span class="line">nginx-1                     1/1     Running   0          43m</span><br><span class="line">nginx-2                     1/1     Running   0          43m</span><br><span class="line">redis-web-db6f7cd87-2pzff   1/1     Running   1          22h</span><br><span class="line">redis-web-db6f7cd87-s4nph   1/1     Running   4          59d</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># </span></span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">#查看dns</span></span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl run -it --image=busybox:1.28.3 --restart=Never -n mall-dev dns-test /bin/sh</span></span><br><span class="line"><span class="comment">#####第一次查看#####</span></span><br><span class="line">/ <span class="comment">#  nslookup nginx-0.nginx</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx-0.nginx</span><br><span class="line">Address 1: 192.167.58.202 nginx-0.nginx.mall-dev.svc.cluster.local</span><br><span class="line">/ <span class="comment">#  nslookup nginx-1.nginx</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx-1.nginx</span><br><span class="line">Address 1: 192.167.85.204 nginx-1.nginx.mall-dev.svc.cluster.local</span><br><span class="line">/ <span class="comment">#  nslookup nginx-2.nginx</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx-2.nginx</span><br><span class="line">Address 1: 192.167.85.203 nginx-2.nginx.mall-dev.svc.cluster.local</span><br><span class="line"><span class="comment">#####第二次查看#####</span></span><br><span class="line">/ <span class="comment">#  nslookup nginx-0.nginx</span></span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx-0.nginx</span><br><span class="line">Address 1: 192.167.58.214 nginx-0.nginx.mall-dev.svc.cluster.local</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="StatefulSet存储状态"><a href="#StatefulSet存储状态" class="headerlink" title="StatefulSet存储状态"></a>StatefulSet存储状态</h3><p><strong><code>StatefulSet可以通过PVC做持久化存储，保证Pod重新调度后还是能访问到相同的持久化数据，在删除Pod时，PVC不会被删除。</code></strong></p>
<img src="/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220816215943427.png" class title="image-20220816215943427">

<h2 id="Job和CronJob"><a href="#Job和CronJob" class="headerlink" title="Job和CronJob"></a>Job和CronJob</h2><p>Job和CronJob是负责批量处理短暂的一次性任务（short lived one-off tasks），即仅执行一次的任务，它保证批处理任务的一个或多个Pod成功结束。</p>
<ul>
<li>Job：是Kubernetes用来控制批处理型任务的资源对象。批处理业务与长期伺服业务（Deployment、Statefulset）的主要区别是批处理业务的运行有头有尾，而长期伺服业务在用户不停止的情况下永远运行。Job管理的Pod根据用户的设置把任务成功完成就自动退出（Pod自动删除）。</li>
<li>CronJob：是基于时间的Job，就类似于Linux系统的crontab文件中的一行，在指定的时间周期运行指定的Job。</li>
</ul>
<p>任务负载的这种用完即停止的特性特别适合一次性任务，比如持续集成。</p>
<table>
<thead>
<tr>
<th>Job类型</th>
<th>说明</th>
<th>使用示例</th>
</tr>
</thead>
<tbody><tr>
<td>一次性Job</td>
<td>创建一个Pod直至其成功结束</td>
<td>数据库迁移</td>
</tr>
<tr>
<td>固定结束次数的Job</td>
<td>依次创建一个Pod运行直至completions个成功结束</td>
<td>处理工作队列的Pod</td>
</tr>
<tr>
<td>固定结束次数的并行Job</td>
<td>依次创建多个Pod运行直至completions个成功结束</td>
<td>多个Pod同时处理工作队列</td>
</tr>
<tr>
<td>并行Job</td>
<td>创建一个或多个Pod直至有一个成功结束</td>
<td>多个Pod同时处理工作队列</td>
</tr>
</tbody></table>
<h3 id="创建Job"><a href="#创建Job" class="headerlink" title="创建Job"></a>创建Job</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: pi-with-timeout</span><br><span class="line">spec:</span><br><span class="line">  completions: 50            # 运行的次数，即Job结束需要成功运行的Pod个数</span><br><span class="line">  parallelism: 5             # 并行运行Pod的数量，默认为1</span><br><span class="line">  backoffLimit: 5            # 表示失败Pod的重试最大次数，超过这个次数不会继续重试。</span><br><span class="line">  activeDeadlineSeconds: 10  # 表示Pod超期时间，一旦达到这个时间，Job及其所有的Pod都会停止。</span><br><span class="line">  template:                  # Pod定义</span><br><span class="line">    spec: </span><br><span class="line">      containers:</span><br><span class="line">      - name: pi</span><br><span class="line">        image: perl</span><br><span class="line">        command:</span><br><span class="line">        - perl</span><br><span class="line">        - &quot;-Mbignum=bpi&quot;</span><br><span class="line">        - &quot;-wle&quot;</span><br><span class="line">        - print bpi(2000)</span><br><span class="line">      restartPolicy: Never</span><br></pre></td></tr></table></figure>

<h3 id="创建CronJob"><a href="#创建CronJob" class="headerlink" title="创建CronJob"></a>创建CronJob</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cronjob-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;0,15,30,45 * * * *&quot;</span>           <span class="comment"># 定时相关配置</span></span><br><span class="line">  <span class="attr">jobTemplate:</span>                             <span class="comment"># Job的定义</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">pi</span></span><br></pre></td></tr></table></figure>

<p>CronJob的格式从前到后就是：</p>
<ul>
<li>Minute</li>
<li>Hour</li>
<li>Day of month</li>
<li>Month</li>
<li>Day of week</li>
</ul>
<h2 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h2><p>DaemonSet是这样一种对象（守护进程），它在集群的每个节点上运行一个Pod，且保证只有一个Pod。</p>
<p>DaemonSet跟节点相关，如果节点异常，也不会在其他节点重新创建。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-daemonset</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-daemonset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-daemonset</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-daemonset</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span>                 <span class="comment"># 节点选择，当节点拥有daemon=need时才在节点上创建Pod</span></span><br><span class="line">        <span class="attr">daemon:</span> <span class="string">need</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-daemonset</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get pod -n mall-dev -owide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP               NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-0                     1/1     Running   1          23h   192.167.58.216   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-1                     1/1     Running   1          24h   192.167.85.205   k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2                     1/1     Running   1          24h   192.167.85.215   k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-daemonset-7q46d       1/1     Running   0          18s   192.167.85.214   k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-daemonset-j2ks7       1/1     Running   0          14s   192.167.58.211   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">redis-web-db6f7cd87-2pzff   1/1     Running   2          46h   192.167.58.210   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">redis-web-db6f7cd87-s4nph   1/1     Running   5          60d   192.167.85.207   k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="亲和与反亲和调度"><a href="#亲和与反亲和调度" class="headerlink" title="亲和与反亲和调度"></a>亲和与反亲和调度</h2><p>通过 Kubernetes 你可以将一个 pod 限制或倾向于在某些特定节点运行。有几种方式可以达到这个目的，它们都通过 **<code>label selectors</code>**进行选择</p>
<h3 id="Node-Label"><a href="#Node-Label" class="headerlink" title="Node Label"></a>Node Label</h3><p>添加label</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node &lt;node_name&gt; key=value</span><br><span class="line"><span class="comment">#命令</span></span><br><span class="line">kubectl label node k8s-node02 app=mall-dev</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> kubectl get node --show-labels</span><br><span class="line"> <span class="comment">#结果</span></span><br><span class="line"> [root@k8s-master yaml]<span class="comment"># kubectl get node --show-labels</span></span><br><span class="line">NAME         STATUS   ROLES                  AGE    VERSION   LABELS</span><br><span class="line">k8s-master   Ready    control-plane,master   245d   v1.21.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">k8s-node01   Ready    worker                 245d   v1.21.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,daemon=need,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node01,kubernetes.io/os=linux,node-role.kubernetes.io/worker=</span><br><span class="line">k8s-node02   Ready    worker                 245d   v1.21.0   app=mall-dev,beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,daemon=need,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node02,kubernetes.io/os=linux,node-role.kubernetes.io/worker=</span><br><span class="line">[root@k8s-master yaml]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>更改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node &lt;node_name&gt; key=value  --overwrite</span><br><span class="line"><span class="comment">#命令更改</span></span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl label node k8s-node02 app=mall-nginx --overwrite</span></span><br><span class="line">node/k8s-node02 labeled</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get node --show-labels</span></span><br><span class="line">NAME         STATUS   ROLES                  AGE    VERSION   LABELS</span><br><span class="line">k8s-master   Ready    control-plane,master   245d   v1.21.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-master,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br><span class="line">k8s-node01   Ready    worker                 245d   v1.21.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,daemon=need,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node01,kubernetes.io/os=linux,node-role.kubernetes.io/worker=</span><br><span class="line">k8s-node02   Ready    worker                 245d   v1.21.0   app=mall-nginx,beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,daemon=need,kubernetes.io/arch=amd64,kubernetes.io/hostname=k8s-node02,kubernetes.io/os=linux,node-role.kubernetes.io/worker=</span><br><span class="line">[root@k8s-master yaml]<span class="comment">#</span></span><br></pre></td></tr></table></figure>



<h3 id="Node-Affinity（节点亲和）"><a href="#Node-Affinity（节点亲和）" class="headerlink" title="Node Affinity（节点亲和）"></a>Node Affinity（节点亲和）</h3><p>通过nodeSelector可以让Pod只部署在具有特定标签的节点上</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span>                 <span class="comment"># 节点选择，当节点拥有app=mall-dev时才在节点上创建Pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mall-nginx</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过节点亲和性规则配置，也可以做到同样的事情</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>  <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span>  <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span>  <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span>  <span class="string">nginx:alpine</span></span><br><span class="line">        <span class="attr">name:</span>  <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;mall-nginx&quot;</span></span><br></pre></td></tr></table></figure>

<p>这里affinity表示亲和，nodeAffinity表示节点亲和，requiredDuringSchedulingIgnoredDuringExecution非常长，不过可以将这个分作两段来看：</p>
<ul>
<li>前半段requiredDuringScheduling表示下面定义的规则必须强制满足（require）才会调度Pod到节点上。</li>
<li>后半段IgnoredDuringExecution表示已经在节点上运行的Pod不需要满足下面定义的规则，即去除节点上的某个标签，那些需要节点包含该标签的Pod不会被重新调度。</li>
</ul>
<p>另外操作符operator的值为In，表示标签值需要在values的列表中，其他operator取值如下。</p>
<ul>
<li>NotIn：标签的值不在某个列表中</li>
<li>In：标签的值在个列表中</li>
<li>Exists：某个标签存在</li>
<li>DoesNotExist：某个标签不存在</li>
<li>Gt：标签的值大于某个值（字符串比较）</li>
<li>Lt：标签的值小于某个值（字符串比较）</li>
</ul>
<p><strong><code>部署对应的yaml文件，查看pod被调度到对应有label的node上</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get pod -n mall-dev -owide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE     IP               NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-0                     1/1     Running   1          24h     192.167.58.216   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-1                     1/1     Running   1          24h     192.167.85.205   k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2                     1/1     Running   1          24h     192.167.85.215   k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-78c67b5cdb-c4lkj      1/1     Running   0          7m21s   192.167.58.221   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-78c67b5cdb-hkpgm      1/1     Running   0          7m21s   192.167.58.222   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-78c67b5cdb-zx97s      1/1     Running   0          7m21s   192.167.58.220   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-daemonset-7q46d       1/1     Running   0          19m     192.167.85.214   k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-daemonset-j2ks7       1/1     Running   0          19m     192.167.58.211   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">redis-web-db6f7cd87-2pzff   1/1     Running   2          46h     192.167.58.210   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">redis-web-db6f7cd87-s4nph   1/1     Running   5          60d     192.167.85.207   k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@k8s-master yaml]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="节点优先选择规则"><a href="#节点优先选择规则" class="headerlink" title="节点优先选择规则"></a>节点优先选择规则</h3><p>节点亲和还有一种优先选择规则，即preferredDuringSchedulingIgnoredDuringExecution，表示会根据规则<strong>优先</strong>选择哪些节点</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>  <span class="string">nginx-label</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span>  <span class="string">nginx-label</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-label</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span>  <span class="string">nginx-label</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span>  <span class="string">nginx:alpine</span></span><br><span class="line">        <span class="attr">name:</span>  <span class="string">nginx-label</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span>  <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span>  <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span>  <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span>  <span class="string">200Mi</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">80</span> </span><br><span class="line">            <span class="attr">preference:</span> </span><br><span class="line">              <span class="attr">matchExpressions:</span> </span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">mall-label</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span> </span><br><span class="line">                <span class="attr">values:</span> </span><br><span class="line">                <span class="bullet">-</span> <span class="string">nginx-label</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">20</span> </span><br><span class="line">            <span class="attr">preference:</span> </span><br><span class="line">              <span class="attr">matchExpressions:</span> </span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span> </span><br><span class="line">                <span class="attr">values:</span> </span><br><span class="line">                <span class="bullet">-</span> <span class="string">&quot;mall-nginx&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong><code>查看部署后的结果</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get pod -n mall-dev -owide</span></span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP                NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-0                       1/1     Running   1          24h   192.167.58.216    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-1                       1/1     Running   1          25h   192.167.85.205    k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2                       1/1     Running   1          25h   192.167.85.215    k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-daemonset-7q46d         1/1     Running   0          47m   192.167.85.214    k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-daemonset-j2ks7         1/1     Running   0          46m   192.167.58.211    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-label-df8799647-67br8   1/1     Running   0          10s   192.167.58.231    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-label-df8799647-8lvnr   1/1     Running   0          10s   192.167.58.238    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-label-df8799647-cp6lz   1/1     Running   0          10s   192.167.135.137   k8s-node03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-label-df8799647-dk2jm   1/1     Running   0          10s   192.167.58.233    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-label-df8799647-f8jcm   1/1     Running   0          10s   192.167.58.242    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-label-df8799647-gnvnv   1/1     Running   0          10s   192.167.135.138   k8s-node03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-label-df8799647-pss49   1/1     Running   0          10s   192.167.135.139   k8s-node03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-label-df8799647-r6l96   1/1     Running   0          10s   192.167.58.230    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-label-df8799647-sl28m   1/1     Running   0          10s   192.167.58.243    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-label-df8799647-zps5t   1/1     Running   0          10s   192.167.58.237    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">redis-web-db6f7cd87-2pzff     1/1     Running   2          47h   192.167.58.210    k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">redis-web-db6f7cd87-s4nph     1/1     Running   5          60d   192.167.85.207    k8s-node01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@k8s-master yaml]<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于节点排序优先级如下所示，有个两个标签的节点排序最高，只有**<code>mall-label=nginx-label</code><strong>标签的节点排序第二（权重为80），只有</strong><code>app=mall-nginx</code>**的节点排序第三，没有的节点排序最低。</p>
<img src="/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220817222302611.png" class title="image-20220817222302611">

<p>Pod并没有调度到 **<code>k8s-node01</code>**这个节点上，这是因为这个节点上部署了很多其他Pod，资源使用较多，所以并没有往这个节点上调度，这也侧面说明preferredDuringSchedulingIgnoredDuringExecution是优先规则，而不是强制规则。</p>
<h3 id="Pod-Affinity（Pod亲和）"><a href="#Pod-Affinity（Pod亲和）" class="headerlink" title="Pod Affinity（Pod亲和）"></a>Pod Affinity（Pod亲和）</h3><p>节点亲和的规则只能影响Pod和节点之间的亲和，Kubernetes还支持Pod和Pod之间的亲和，例如多个pod不会同时被调度到同一个node上面，或者前端和后端部署在同一个node上，从而减少访问延迟等。</p>
<p>Pod亲和同样有requiredDuringSchedulingIgnoredDuringExecution和preferredDuringSchedulingIgnoredDuringExecution两种规则</p>
<p><strong><code>调度时，先对node的label【kubernetes.io/hostname，表示所有node】进行匹配，然后在对pod的label【app=backend】进行匹配,完成后对新调度的pod进行亲和</code></strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>   <span class="string">frontend</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span>  <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span>  <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span>  <span class="string">nginx:alpine</span></span><br><span class="line">        <span class="attr">name:</span>  <span class="string">frontend</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span>  <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span>  <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span>  <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span>  <span class="string">200Mi</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span> <span class="comment">#node的label</span></span><br><span class="line">            <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span> </span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span> <span class="comment">#pod的label app=backed</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span> </span><br><span class="line">                <span class="attr">values:</span> </span><br><span class="line">                <span class="bullet">-</span> <span class="string">backend</span></span><br></pre></td></tr></table></figure>

<h3 id="Pod-AntiAffinity（Pod反亲和）"><a href="#Pod-AntiAffinity（Pod反亲和）" class="headerlink" title="Pod AntiAffinity（Pod反亲和）"></a>Pod AntiAffinity（Pod反亲和）</h3><p><strong><code>调度时，先对node的label【kubernetes.io/hostname，表示所有node】进行匹配，然后在对pod的label【app=frontend】进行匹配,完成后对新调度的pod进行反亲和</code></strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span>   <span class="string">frontend</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span>  <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span>  <span class="string">frontend</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span>  <span class="string">nginx:alpine</span></span><br><span class="line">        <span class="attr">name:</span>  <span class="string">frontend</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span>  <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span>  <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span>  <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span>  <span class="string">200Mi</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span> <span class="comment">#node的label</span></span><br><span class="line">            <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span> </span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span> <span class="comment">#pod的label app=frontend</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span> </span><br><span class="line">                <span class="attr">values:</span> </span><br><span class="line">                <span class="bullet">-</span> <span class="string">frontend</span></span><br></pre></td></tr></table></figure>

<p>你可以针对 Pod 间亲和性与反亲和性为其 <code>operator</code> 字段使用 <code>In</code>、<code>NotIn</code>、<code>Exists</code>、 <code>DoesNotExist</code> 等值。</p>
<p>原则上，<code>topologyKey</code> 可以是任何合法的标签键。出于性能和安全原因，<code>topologyKey</code> 有一些限制：</p>
<ul>
<li>对于 Pod 亲和性而言，在 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 和 <code>preferredDuringSchedulingIgnoredDuringExecution</code> 中，<code>topologyKey</code> 不允许为空。</li>
<li>对于 <code>requiredDuringSchedulingIgnoredDuringExecution</code> 要求的 Pod 反亲和性， 准入控制器 <code>LimitPodHardAntiAffinityTopology</code> 要求 <code>topologyKey</code> 只能是 <code>kubernetes.io/hostname</code>。如果你希望使用其他定制拓扑逻辑， 你可以更改准入控制器或者禁用之。</li>
</ul>
<p>除了 <code>labelSelector</code> 和 <code>topologyKey</code>，你也可以指定 <code>labelSelector</code> 要匹配的命名空间列表，方法是在 <code>labelSelector</code> 和 <code>topologyKey</code> 所在层同一层次上设置 <code>namespaces</code>。 如果 <code>namespaces</code> 被忽略或者为空，则默认为 Pod 亲和性&#x2F;反亲和性的定义所在的命名空间。</p>
<h1 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h1><h2 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h2><h3 id="Volume的类型"><a href="#Volume的类型" class="headerlink" title="Volume的类型"></a>Volume的类型</h3><p>Kubernetes的Volume有非常多的类型，在实际使用中使用最多的类型如下。</p>
<ul>
<li>emptyDir：一种简单的空目录，主要用于临时存储。</li>
<li>hostPath：将主机某个目录挂载到容器中。</li>
<li>ConfigMap、Secret：特殊类型，将Kubernetes特定的对象类型挂载到Pod</li>
<li>persistentVolumeClaim：Kubernetes的持久化存储类型。</li>
</ul>
<h3 id="EmptyDir"><a href="#EmptyDir" class="headerlink" title="EmptyDir"></a>EmptyDir</h3><p>EmptyDir是最简单的一种Volume类型，根据名字就能看出，这个Volume挂载后就是一个空目录，应用程序可以在里面读写文件，emptyDir Volume的生命周期与Pod相同，Pod删除后Volume的数据也同时删除掉。</p>
<p>emptyDir的一些用途：</p>
<ul>
<li>缓存空间，例如基于磁盘的归并排序。</li>
<li>为耗时较长的计算任务提供检查点，以便任务能从崩溃前状态恢复执行。</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>另外emptyDir也可以设置存储介质为内存，如下所示，medium设置为Memory</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/cache</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cache-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">emptyDir:</span></span><br><span class="line">        <span class="attr">medium:</span> <span class="string">Memory</span></span><br></pre></td></tr></table></figure>

<h3 id="HostPath"><a href="#HostPath" class="headerlink" title="HostPath"></a>HostPath</h3><p>HostPath是一种持久化存储，emptyDir里面的内容会随着Pod的删除而消失，但HostPath不会，如果对应的Pod删除，HostPath Volume里面的内容依然存在于节点的目录中，如果后续重新创建Pod并调度到同一个节点，挂载后依然可以读取到之前Pod写的内容。</p>
<p>HostPath存储的内容与节点相关，所以它不适合像数据库这类的应用，想象下如果数据库的Pod被调度到别的节点了，那读取的内容就完全不一样了。</p>
<p>记住永远不要使用HostPath存储跨Pod的数据，一定要把HostPath的使用范围限制在读取节点文件上，这是因为Pod被重建后不确定会调度哪个节点上，写文件可能会导致前后不一致。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-hostpath</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hostpath-container</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/test-pd</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br></pre></td></tr></table></figure>

<h3 id="在Volume中引用ConfigMap"><a href="#在Volume中引用ConfigMap" class="headerlink" title="在Volume中引用ConfigMap"></a>在Volume中引用ConfigMap</h3><p>在Volume中引用ConfigMap，就是通过文件的方式直接将ConfigMap的每条数据填入Volume，每条数据是一个文件，键就是文件名，键值就是文件内容。</p>
<p>创建一个名为vol-configmap的Volume，这个Volume引用名为<strong>“configmap-test”</strong>的ConfigMap，再将Volume挂载到容器的“&#x2F;tmp”路径下。Pod创建成功后，在容器的“&#x2F;tmp”路径下，就有两个文件property_1和property_2，它们的值分别为“Hello”和“World”。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configmap-test</span></span><br><span class="line"><span class="attr">data:</span>                     <span class="comment"># 配置数据</span></span><br><span class="line">  <span class="attr">property_1:</span> <span class="string">Hello</span></span><br><span class="line">  <span class="attr">property_2:</span> <span class="string">World</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">container-0</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vol-configmap</span>           <span class="comment"># 挂载名为vol-configmap的Volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/tmp&quot;</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vol-configmap</span></span><br><span class="line">    <span class="attr">configMap:</span>                      <span class="comment"># 引用ConfigMap</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">configmap-test</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<h3 id="在Volume中引用Secret"><a href="#在Volume中引用Secret" class="headerlink" title="在Volume中引用Secret"></a>在Volume中引用Secret</h3><p>在Volume中引用Secret，就是通过文件的方式直接将Secret的每条数据填入Volume，每条数据是一个文件，键就是文件名，键值就是文件内容。</p>
<p>如下示例中，创建一个名为vol-secret的Volume，这个Volume引用名为<strong>“mysecret”</strong>的Secret，再将Volume挂载到容器的“&#x2F;tmp”路径下。Pod创建成功后，在容器的“&#x2F;tmp”路径下，就有两个文件key1和key2。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">key1:</span> <span class="string">aGVsbG8gd29ybGQ=</span>   <span class="comment"># &quot;hello world&quot; Base64编码后的值</span></span><br><span class="line">  <span class="attr">key2:</span> <span class="string">MzMwNg==</span>           <span class="comment"># &quot;3306&quot; Base64编码后的值</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">container-0</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vol-secret</span>              <span class="comment"># 挂载名为vol-secret的Volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/tmp&quot;</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-secret</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vol-secret</span></span><br><span class="line">    <span class="attr">secret:</span>                         <span class="comment"># 引用Secret</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<h2 id="PV、PVC和StorageClass"><a href="#PV、PVC和StorageClass" class="headerlink" title="PV、PVC和StorageClass"></a>PV、PVC和StorageClass</h2><p>如果要求Pod重新调度后仍然能使用之前读写过的数据，就只能使用网络存储了，网络存储种类非常多且有不同的使用方法。Kubernetes解决这个问题的方式是抽象了PV（PersistentVolume）和PVC（PersistentVolumeClaim）来解耦这个问题</p>
<ul>
<li>PV：PV描述的是持久化存储卷，主要定义的是一个持久化存储在宿主机上的目录，比如一个NFS的挂载目录。</li>
<li>PVC：PVC描述的是Pod所希望使用的持久化存储的属性，比如，Volume存储的大小、可读写权限等等。</li>
</ul>
<p>Kubernetes管理员设置好网络存储的类型，提供对应的PV描述符配置到Kubernetes，使用者需要存储的时候只需要创建PVC，然后在Pod中使用Volume关联PVC，即可让Pod使用到存储资源。</p>
<img src="/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220818185709648.png" class title="image-20220818185709648">

<h3 id="CSI"><a href="#CSI" class="headerlink" title="CSI"></a>CSI</h3><p>Kubernetes提供了CSI接口（Container Storage Interface，容器存储接口），基于CSI这套接口，可以开发定制出CSI插件，从而支持特定的存储，达到解耦的目的。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看csi插件</span></span><br><span class="line">kubectl get po -n kube-system </span><br><span class="line">NAME                                                    READY   STATUS      RESTARTS       AGE</span><br><span class="line">csi-nfs-controller-fdb9f88b4-4rhd4                      3/3     Running     3 (25h ago)    5d11h</span><br><span class="line">csi-nfs-controller-fdb9f88b4-vw2j6                      3/3     Running     5 (25h ago)    5d11h</span><br><span class="line">csi-nfs-node-77rsl                                      3/3     Running     6 (25h ago)    5d12h</span><br><span class="line">csi-nfs-node-8bnhj                                      3/3     Running     6 (25h ago)    5d12h</span><br><span class="line">csi-nfs-node-8jptr                                      3/3     Running     6 (25h ago)    5d12h</span><br><span class="line">csi-nfs-node-bnh69                                      3/3     Running     9 (25h ago)    5d12h</span><br><span class="line">csi-nfs-node-hl2pg                                      3/3     Running     7 (25h ago)    5d13h</span><br><span class="line">csi-nfs-node-jgt46                                      3/3     Running     6 (25h ago)    5d13h</span><br><span class="line">csi-nfs-node-qwwd2                                      3/3     Running     6 (25h ago)    5d12h</span><br><span class="line">csi-smb-controller-8bdc4fc89-7k5cx                      3/3     Running     8 (25h ago)    5d11h</span><br><span class="line">csi-smb-controller-8bdc4fc89-st5d4                      3/3     Running     6 (25h ago)    5d11h</span><br><span class="line">csi-smb-node-4hf9g                                      3/3     Running     6 (25h ago)    5d12h</span><br><span class="line">csi-smb-node-85km7                                      3/3     Running     9 (25h ago)    5d12h</span><br><span class="line">csi-smb-node-cflt2                                      3/3     Running     6 (25h ago)    5d12h</span><br><span class="line">csi-smb-node-cl8xb                                      3/3     Running     6 (25h ago)    5d13h</span><br><span class="line">csi-smb-node-k2cv7                                      3/3     Running     6 (25h ago)    5d12h</span><br><span class="line">csi-smb-node-k5z6b                                      3/3     Running     6 (25h ago)    5d12h</span><br><span class="line">csi-smb-node-nrtps </span><br></pre></td></tr></table></figure>



<h3 id="PV"><a href="#PV" class="headerlink" title="PV"></a>PV</h3><p>Kubernetes管理员设置好网络存储的类型，提供对应的PV描述符配置到Kubernetes，使用者需要存储的时候只需要创建PVC，然后在Pod中使用Volume关联PVC，即可让Pod使用到存储资源</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span>									<span class="comment"># 读写模式</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">5Gi</span>									<span class="comment"># 定义PV的大小</span></span><br><span class="line">  <span class="attr">csi:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">smb.csi.k8s.io</span>				<span class="comment"># 声明使用的驱动</span></span><br><span class="line">    <span class="attr">nodeStageSecretRef:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cifs-secret</span>						<span class="comment"># 访问cfs使用的密码  </span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">mall-dev</span>					<span class="comment"># secret所在的命名空间  </span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumeAttributes:</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">//cfs_hostname/mall/dev</span>										<span class="comment"># 挂载地址</span></span><br><span class="line">    <span class="attr">volumeHandle:</span> <span class="string">68e4a4fd-d759-444b-8265-20dc66c8c502</span> 	<span class="comment"># 存储ID</span></span><br><span class="line">  <span class="attr">mountOptions:</span>										<span class="comment"># 设置文件夹的挂载选项，比如文件夹权限，用户组等</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">dir_mode=0777</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">file_mode=0777</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">uid=1001</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gid=1001</span></span><br></pre></td></tr></table></figure>

<h3 id="PVC"><a href="#PVC" class="headerlink" title="PVC"></a>PVC</h3><p>PVC可以绑定一个PV</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span>              <span class="comment"># 声明存储的大小</span></span><br><span class="line">  <span class="attr">volumeName:</span> <span class="string">pv-example</span>         <span class="comment"># PV的名称</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建并查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f pvc.yaml -n mall-dev</span><br><span class="line">persistentvolumeclaim/pvc-example created</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc -n mall-dev</span><br><span class="line">NAME          STATUS   VOLUME       CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-example   Bound    pv-example   5Gi       RWO                           9s</span><br></pre></td></tr></table></figure>

<h3 id="StorageClass"><a href="#StorageClass" class="headerlink" title="StorageClass"></a>StorageClass</h3><p>PV和PVC方法虽然能实现屏蔽底层存储，但是PV创建比较复杂（可以看到PV中csi字段的配置很麻烦）</p>
<p>Kubernetes解决这个问题的方法是提供动态配置PV的方法，可以自动创PV。管理员可以部署PV配置器（provisioner），然后定义对应的StorageClass，这样开发者在创建PVC的时候就可以选择需要创建存储的类型，PVC会把StorageClass传递给PV provisioner，由provisioner自动创建PV。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get sc</span><br><span class="line">NAME      PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">nfs-csi   nfs.csi.k8s.io   Retain          Immediate           <span class="literal">false</span>                  191d</span><br></pre></td></tr></table></figure>



<h1 id="弹性伸缩"><a href="#弹性伸缩" class="headerlink" title="弹性伸缩"></a>弹性伸缩</h1><h4 id="HPA工作机制"><a href="#HPA工作机制" class="headerlink" title="HPA工作机制"></a>HPA工作机制</h4><p>HPA（Horizontal Pod Autoscaler）是用来控制Pod水平伸缩的控制器，HPA周期性检查Pod的度量数据，计算满足HPA资源所配置的目标数值所需的副本数量，进而调整目标资源（如Deployment）的replicas字段。<img src="/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/image-20220818200748512.png" class title="image-20220818200748512"></p>
<p>HPA可以配置单个和多个度量指标，配置单个度量指标时，只需要对Pod的当前度量数据求和，除以期望目标值，然后向上取整，就能得到期望的副本数。例如有一个Deployment控制有3个Pod，每个Pod的CPU使用率是70%、50%、90%，而HPA中配置的期望值是50%，计算期望副本数&#x3D;（70 + 50 + 90）&#x2F;50 &#x3D; 4.2，向上取整得到5，即期望副本数就是5。</p>
<p>如果是配置多个度量指标，则会分别计算单个度量指标的期望副本数量，然后取其中最大值，就是最终的期望副本数量。</p>
<p>使用HPA（Horizontal Pod Autoscaler）配合Metrics Server可以实现基于CPU和内存的自动弹性伸缩，再配合Prometheus还可以实现自定义监控指标的自动弹性伸缩。</p>
<p><strong><code>部署Metrics </code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#将yaml中的镜像地址更改和添加取消证书校验</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: metrics-server</span><br><span class="line">  name: metrics-server</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: metrics-server</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxUnavailable: 0</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: metrics-server</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --cert-dir=/tmp</span><br><span class="line">        - --secure-port=4443</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">        - --kubelet-use-node-status-port</span><br><span class="line">        - --metric-resolution=15s</span><br><span class="line">        - --kubelet-insecure-tls <span class="comment">#禁用证书验证</span></span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/chenby/metrics-server:v0.6.1 <span class="comment">#镜像地址</span></span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure>

<p><strong><code>创建一个deployment</code></strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>      <span class="comment"># 注意这里与Pod的区别，Deployment是apps/v1而不是v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>         <span class="comment"># 资源类型为Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span>            <span class="comment"># Deployment的名称</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span>            <span class="comment"># Pod的数量，Deployment会确保一直有2个Pod运行         </span></span><br><span class="line">  <span class="attr">selector:</span>              <span class="comment"># Label Selector</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span>              <span class="comment"># Pod的定义，用于创建Pod，也称为Pod template</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">container-0</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br></pre></td></tr></table></figure>

<p><code>**创建一个HPA</code>**</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">scale</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span>                    <span class="comment"># 目标资源的最大副本数量</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span>                     <span class="comment"># 目标资源的最小副本数量</span></span><br><span class="line">  <span class="attr">metrics:</span>                           <span class="comment"># 度量指标，期望CPU的利用率为70%</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">targetAverageUtilization:</span> <span class="number">70</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span>                    <span class="comment"># 目标资源</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<p><strong><code>查看部署后的结果</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get pod -n mall-dev</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-56d58c56c7-7tqxb      1/1     Running   0          91s</span><br><span class="line">nginx-56d58c56c7-cjg7x      1/1     Running   0          91s</span><br><span class="line">nginx-56d58c56c7-k49k2      1/1     Running   0          91s</span><br><span class="line">nginx-56d58c56c7-qp2xw      1/1     Running   0          91s</span><br><span class="line">nginx-56d58c56c7-rf545      1/1     Running   0          91s</span><br><span class="line">nginx-56d58c56c7-v998j      1/1     Running   0          91s</span><br><span class="line">redis-web-db6f7cd87-2pzff   1/1     Running   3          2d22h</span><br><span class="line">redis-web-db6f7cd87-s4nph   1/1     Running   6          61d</span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get hpa -n mall-dev</span></span><br><span class="line">NAME    REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">scale   Deployment/nginx   0%/70%    1         10        6          93s</span><br><span class="line">[root@k8s-master yaml]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>可以看到，TARGETS的期望值是70%，而实际是0%，这就意味着HPA会做出缩容动作，期望副本数量&#x3D;(0+0+0+0)&#x2F;70&#x3D;0，但是由于最小副本数为1，所以Pod数量会调整为1。等待一段时间，可以看到Pod数量变为1</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pod数量变为1</span></span><br><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl get pod -n mall-dev</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-56d58c56c7-v998j      1/1     Running   0          5m40s</span><br><span class="line">redis-web-db6f7cd87-2pzff   1/1     Running   3          2d22h</span><br><span class="line">redis-web-db6f7cd87-s4nph   1/1     Running   6          61d</span><br><span class="line">[root@k8s-master yaml]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p><strong><code>查看deployment的event</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl describe deployments.apps -n mall-dev nginx</span></span><br><span class="line">Name:                   nginx</span><br><span class="line">Namespace:              mall-dev</span><br><span class="line">CreationTimestamp:      Thu, 18 Aug 2022 21:47:52 +0800</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 1</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   container-0:</span><br><span class="line">    Image:      nginx:latest</span><br><span class="line">    Port:       &lt;none&gt;</span><br><span class="line">    Host Port:  &lt;none&gt;</span><br><span class="line">    Limits:</span><br><span class="line">      cpu:     100m</span><br><span class="line">      memory:  200Mi</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:        100m</span><br><span class="line">      memory:     200Mi</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   nginx-56d58c56c7 (1/1 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age    From                   Message</span><br><span class="line">  ----    ------             ----   ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  6m58s  deployment-controller  Scaled up replica <span class="built_in">set</span> nginx-56d58c56c7 to 6</span><br><span class="line">  Normal  ScalingReplicaSet  103s   deployment-controller  Scaled down replica <span class="built_in">set</span> nginx-56d58c56c7 to 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><code>查看hpa的event</code></strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master yaml]<span class="comment"># kubectl describe deployments.apps -n mall-dev nginx</span></span><br><span class="line">Name:                   nginx</span><br><span class="line">Namespace:              mall-dev</span><br><span class="line">CreationTimestamp:      Thu, 18 Aug 2022 21:47:52 +0800</span><br><span class="line">Labels:                 &lt;none&gt;</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 1</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   container-0:</span><br><span class="line">    Image:      nginx:latest</span><br><span class="line">    Port:       &lt;none&gt;</span><br><span class="line">    Host Port:  &lt;none&gt;</span><br><span class="line">    Limits:</span><br><span class="line">      cpu:     100m</span><br><span class="line">      memory:  200Mi</span><br><span class="line">    Requests:</span><br><span class="line">      cpu:        100m</span><br><span class="line">      memory:     200Mi</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   nginx-56d58c56c7 (1/1 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age    From                   Message</span><br><span class="line">  ----    ------             ----   ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  6m58s  deployment-controller  Scaled up replica <span class="built_in">set</span> nginx-56d58c56c7 to 6</span><br><span class="line">  Normal  ScalingReplicaSet  103s   deployment-controller  Scaled down replica <span class="built_in">set</span> nginx-56d58c56c7 to 1</span><br><span class="line">[root@k8s-master yaml]<span class="comment">#  kubectl describe hpa scale -n mall-dev</span></span><br><span class="line">Name:                                                  scale</span><br><span class="line">Namespace:                                             mall-dev</span><br><span class="line">Labels:                                                &lt;none&gt;</span><br><span class="line">Annotations:                                           &lt;none&gt;</span><br><span class="line">CreationTimestamp:                                     Thu, 18 Aug 2022 21:47:52 +0800</span><br><span class="line">Reference:                                             Deployment/nginx</span><br><span class="line">Metrics:                                               ( current / target )</span><br><span class="line">  resource cpu on pods  (as a percentage of request):  0% (0) / 70%</span><br><span class="line">Min replicas:                                          1</span><br><span class="line">Max replicas:                                          10</span><br><span class="line">Deployment pods:                                       1 current / 1 desired</span><br><span class="line">Conditions:</span><br><span class="line">  Type            Status  Reason            Message</span><br><span class="line">  ----            ------  ------            -------</span><br><span class="line">  AbleToScale     True    ReadyForNewScale  recommended size matches current size</span><br><span class="line">  ScalingActive   True    ValidMetricFound  the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request)</span><br><span class="line">  ScalingLimited  True    TooFewReplicas    the desired replica count is less than the minimum replica count</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason                        Age                    From                       Message</span><br><span class="line">  ----     ------                        ----                   ----                       -------</span><br><span class="line">  Warning  FailedGetResourceMetric       7m20s (x2 over 7m35s)  horizontal-pod-autoscaler  failed to get cpu utilization: unable to get metrics <span class="keyword">for</span> resource cpu: no metrics returned from resource metrics API</span><br><span class="line">  Warning  FailedComputeMetricsReplicas  7m20s (x2 over 7m35s)  horizontal-pod-autoscaler  invalid metrics (1 invalid out of 1), first error is: failed to get cpu utilization: unable to get metrics <span class="keyword">for</span> resource cpu: no metrics returned from resource metrics API</span><br><span class="line">  Warning  FailedGetResourceMetric       7m5s                   horizontal-pod-autoscaler  failed to get cpu utilization: did not receive metrics <span class="keyword">for</span> any ready pods</span><br><span class="line">  Warning  FailedComputeMetricsReplicas  7m5s                   horizontal-pod-autoscaler  invalid metrics (1 invalid out of 1), first error is: failed to get cpu utilization: did not receive metrics <span class="keyword">for</span> any ready pods</span><br><span class="line">  Normal   SuccessfulRescale             2m35s                  horizontal-pod-autoscaler  New size: 1; reason: All metrics below target</span><br><span class="line"></span><br></pre></td></tr></table></figure>
























































































































    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/K8S/" rel="tag"><i class="fa fa-tag"></i> K8S</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/01/02/k8s/K8S%E5%9F%BA%E7%A1%80/" rel="prev" title="k8s基础架构">
      <i class="fa fa-chevron-left"></i> k8s基础架构
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/01/02/k8s/k8s%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" rel="next" title="k8s常用命令">
      k8s常用命令 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes-%E7%BB%84%E4%BB%B6"><span class="nav-number">1.</span> <span class="nav-text">Kubernetes 组件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes%E7%9A%84%E6%89%A9%E5%B1%95%E6%80%A7"><span class="nav-number">2.</span> <span class="nav-text">Kubernetes的扩展性</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes%E4%B8%AD%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.</span> <span class="nav-text">Kubernetes中的基本对象</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%8F%8F%E8%BF%B0"><span class="nav-number">4.</span> <span class="nav-text">Kubernetes对象的描述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Pod"><span class="nav-number">5.</span> <span class="nav-text">Pod</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF"><span class="nav-number">5.1.</span> <span class="nav-text">Pod基础信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod-%E5%AD%98%E6%B4%BB%E6%8E%A2%E9%92%88%EF%BC%88Liveness-Probe%EF%BC%89"><span class="nav-number">5.2.</span> <span class="nav-text">Pod 存活探针（Liveness Probe）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-GET"><span class="nav-number">5.2.1.</span> <span class="nav-text">HTTP GET</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-Socket"><span class="nav-number">5.2.2.</span> <span class="nav-text">TCP Socket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exec"><span class="nav-number">5.2.3.</span> <span class="nav-text">Exec</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pod%E5%B0%B1%E7%BB%AA%E6%8E%A2%E9%92%88%EF%BC%88Readiness-Probe%EF%BC%89"><span class="nav-number">5.3.</span> <span class="nav-text">Pod就绪探针（Readiness Probe）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HTTP-GET-1"><span class="nav-number">5.3.1.</span> <span class="nav-text">HTTP GET</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-Socket-1"><span class="nav-number">5.3.2.</span> <span class="nav-text">TCP Socket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exec-1"><span class="nav-number">5.3.3.</span> <span class="nav-text">Exec</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Label"><span class="nav-number">5.4.</span> <span class="nav-text">Label</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0Label"><span class="nav-number">5.4.1.</span> <span class="nav-text">添加Label</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8BLabel"><span class="nav-number">5.4.2.</span> <span class="nav-text">查看Label</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9Label"><span class="nav-number">5.4.3.</span> <span class="nav-text">修改Label</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Pod%E7%9A%84%E7%BC%96%E6%8E%92%E4%B8%8E%E8%B0%83%E5%BA%A6"><span class="nav-number">6.</span> <span class="nav-text">Pod的编排与调度</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Deployment"><span class="nav-number">6.1.</span> <span class="nav-text">Deployment</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Deployment%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-number">6.1.1.</span> <span class="nav-text">Deployment的创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deployment%E6%8E%A7%E5%88%B6Pod"><span class="nav-number">6.1.2.</span> <span class="nav-text">Deployment控制Pod</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deployment%E5%8D%87%E7%BA%A7"><span class="nav-number">6.1.3.</span> <span class="nav-text">Deployment升级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deployment%E5%9B%9E%E6%BB%9A"><span class="nav-number">6.1.4.</span> <span class="nav-text">Deployment回滚</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StatefulSet"><span class="nav-number">6.2.</span> <span class="nav-text">StatefulSet</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAHeadless-Service"><span class="nav-number">6.2.1.</span> <span class="nav-text">创建Headless Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAStatefulset"><span class="nav-number">6.2.2.</span> <span class="nav-text">创建Statefulset</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#StatefulSet%E7%9A%84%E7%BD%91%E7%BB%9C%E6%A0%87%E8%AF%86"><span class="nav-number">6.2.3.</span> <span class="nav-text">StatefulSet的网络标识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#StatefulSet%E5%AD%98%E5%82%A8%E7%8A%B6%E6%80%81"><span class="nav-number">6.2.4.</span> <span class="nav-text">StatefulSet存储状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Job%E5%92%8CCronJob"><span class="nav-number">6.3.</span> <span class="nav-text">Job和CronJob</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAJob"><span class="nav-number">6.3.1.</span> <span class="nav-text">创建Job</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BACronJob"><span class="nav-number">6.3.2.</span> <span class="nav-text">创建CronJob</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DaemonSet"><span class="nav-number">6.4.</span> <span class="nav-text">DaemonSet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%B2%E5%92%8C%E4%B8%8E%E5%8F%8D%E4%BA%B2%E5%92%8C%E8%B0%83%E5%BA%A6"><span class="nav-number">6.5.</span> <span class="nav-text">亲和与反亲和调度</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Node-Label"><span class="nav-number">6.5.1.</span> <span class="nav-text">Node Label</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Node-Affinity%EF%BC%88%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%EF%BC%89"><span class="nav-number">6.5.2.</span> <span class="nav-text">Node Affinity（节点亲和）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E4%BC%98%E5%85%88%E9%80%89%E6%8B%A9%E8%A7%84%E5%88%99"><span class="nav-number">6.5.3.</span> <span class="nav-text">节点优先选择规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod-Affinity%EF%BC%88Pod%E4%BA%B2%E5%92%8C%EF%BC%89"><span class="nav-number">6.5.4.</span> <span class="nav-text">Pod Affinity（Pod亲和）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod-AntiAffinity%EF%BC%88Pod%E5%8F%8D%E4%BA%B2%E5%92%8C%EF%BC%89"><span class="nav-number">6.5.5.</span> <span class="nav-text">Pod AntiAffinity（Pod反亲和）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="nav-number">7.</span> <span class="nav-text">持久化存储</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Volume"><span class="nav-number">7.1.</span> <span class="nav-text">Volume</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Volume%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-number">7.1.1.</span> <span class="nav-text">Volume的类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EmptyDir"><span class="nav-number">7.1.2.</span> <span class="nav-text">EmptyDir</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HostPath"><span class="nav-number">7.1.3.</span> <span class="nav-text">HostPath</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8Volume%E4%B8%AD%E5%BC%95%E7%94%A8ConfigMap"><span class="nav-number">7.1.4.</span> <span class="nav-text">在Volume中引用ConfigMap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8Volume%E4%B8%AD%E5%BC%95%E7%94%A8Secret"><span class="nav-number">7.1.5.</span> <span class="nav-text">在Volume中引用Secret</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PV%E3%80%81PVC%E5%92%8CStorageClass"><span class="nav-number">7.2.</span> <span class="nav-text">PV、PVC和StorageClass</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CSI"><span class="nav-number">7.2.1.</span> <span class="nav-text">CSI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PV"><span class="nav-number">7.2.2.</span> <span class="nav-text">PV</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PVC"><span class="nav-number">7.2.3.</span> <span class="nav-text">PVC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#StorageClass"><span class="nav-number">7.2.4.</span> <span class="nav-text">StorageClass</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9"><span class="nav-number">8.</span> <span class="nav-text">弹性伸缩</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HPA%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="nav-number">8.0.0.1.</span> <span class="nav-text">HPA工作机制</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">doubao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/dooubb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;dooubb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/oge@live.com" title="E-Mail → oge@live.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备2022022850号-2 </a>
  </div>


<div class="copyright" text-align:center>
  &copy; 2021 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">doubao <span id="sitetime"></span>
 <!-- <script language=javascript>
	function siteTime(){
		window.setTimeout("siteTime()", 1000);
		var seconds = 1000;
		var minutes = seconds * 60;
		var hours = minutes * 60;
		var days = hours * 24;
		var years = days * 365;
		var today = new Date();
		var todayYear = today.getFullYear();
		var todayMonth = today.getMonth()+1;
		var todayDate = today.getDate();
		var todayHour = today.getHours();
		var todayMinute = today.getMinutes();
		var todaySecond = today.getSeconds();
		/* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
		year - 作为date对象的年份，为4位年份值
		month - 0-11之间的整数，做为date对象的月份
		day - 1-31之间的整数，做为date对象的天数
		hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
		minutes - 0-59之间的整数，做为date对象的分钟数
		seconds - 0-59之间的整数，做为date对象的秒数
		microseconds - 0-999之间的整数，做为date对象的毫秒数 */
		var t1 = Date.UTC(2018,02,13,15,00,00); //北京时间2018-2-13 00:00:00
		var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
		var diff = t2-t1;
		var diffYears = Math.floor(diff/years);
		var diffDays = Math.floor((diff/days)-diffYears*365);
		var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
		var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
		var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
		document.getElementById("sitetime").innerHTML=" 已运行"+/*diffYears+" 年 "+*/diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
	}/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
	siteTime();
	</script>
	--!>
	</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
